name: Deploy Pipeline

on:
  push:
    tags:
      - "v*.*.*"

env:
  PYTHON_VERSION: "3.10"

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Add UV to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          make install

      - name: Run quality checks
        run: |
          source .venv/bin/activate
          make check

  deploy-test:
    name: Deploy to Test Environment
    runs-on: ubuntu-latest
    needs: test
    environment: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Add UV to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          make install

      - name: Build agents
        run: |
          source .venv/bin/activate
          make build

      - name: Deploy to Test
        run: |
          source .venv/bin/activate
          make deploy ENV=test
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_TEST_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TEST_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Run performance tests
        run: |
          source .venv/bin/activate
          make performance-test
        continue-on-error: true

      - name: Notify Teams - Success
        if: success()
        run: |
          source .venv/bin/activate
          python -c "
          from shared.monitoring import TeamsNotifier
          notifier = TeamsNotifier('${{ secrets.TEAMS_WEBHOOK_URL }}')
          notifier.send_deployment_notification(
              environment='test',
              version='${{ github.ref_name }}',
              status='success',
              details={'commit': '${{ github.sha }}', 'actor': '${{ github.actor }}'}
          )
          "

      - name: Notify Teams - Failure
        if: failure()
        run: |
          source .venv/bin/activate
          python -c "
          from shared.monitoring import TeamsNotifier
          notifier = TeamsNotifier('${{ secrets.TEAMS_WEBHOOK_URL }}')
          notifier.send_deployment_notification(
              environment='test',
              version='${{ github.ref_name }}',
              status='failed',
              details={'commit': '${{ github.sha }}', 'actor': '${{ github.actor }}'}
          )
          "

  deploy-acceptance:
    name: Deploy to Acceptance Environment
    runs-on: ubuntu-latest
    needs: deploy-test
    environment: acceptance
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Add UV to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          make install

      - name: Build agents
        run: |
          source .venv/bin/activate
          make build

      - name: Deploy to Acceptance
        run: |
          source .venv/bin/activate
          make deploy ENV=acceptance
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_ACC_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_ACC_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Notify Teams
        if: always()
        run: |
          source .venv/bin/activate
          python -c "
          from shared.monitoring import TeamsNotifier
          notifier = TeamsNotifier('${{ secrets.TEAMS_WEBHOOK_URL }}')
          status = 'success' if '${{ job.status }}' == 'success' else 'failed'
          notifier.send_deployment_notification(
              environment='acceptance',
              version='${{ github.ref_name }}',
              status=status,
              details={'commit': '${{ github.sha }}', 'actor': '${{ github.actor }}'}
          )
          "

  deploy-production:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    needs: deploy-acceptance
    environment:
      name: production
      url: https://api.production.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Add UV to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          make install

      - name: Build agents
        run: |
          source .venv/bin/activate
          make build

      - name: Deploy to Production
        run: |
          source .venv/bin/activate
          make deploy ENV=production
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_PROD_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_PROD_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            Production deployment of version ${{ github.ref_name }}
            
            Changes included in this release:
            - See commit history for details
          draft: false
          prerelease: false

      - name: Notify Teams - Success
        if: success()
        run: |
          source .venv/bin/activate
          python -c "
          from shared.monitoring import TeamsNotifier
          notifier = TeamsNotifier('${{ secrets.TEAMS_WEBHOOK_URL }}')
          notifier.send_deployment_notification(
              environment='production',
              version='${{ github.ref_name }}',
              status='success',
              details={
                  'commit': '${{ github.sha }}',
                  'actor': '${{ github.actor }}',
                  'release_url': 'https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}'
              }
          )
          "

      - name: Notify Teams - Failure
        if: failure()
        run: |
          source .venv/bin/activate
          python -c "
          from shared.monitoring import TeamsNotifier
          notifier = TeamsNotifier('${{ secrets.TEAMS_WEBHOOK_URL }}')
          notifier.send_error(
              title='Production Deployment Failed',
              error='Deployment of version ${{ github.ref_name }} to production failed',
              details={'commit': '${{ github.sha }}', 'actor': '${{ github.actor }}'}
          )
          "